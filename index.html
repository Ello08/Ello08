<!DOCTYPE html>

<html lang="tr">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Ellolist: Kişisel Medya Takip Uygulaması</title>

    <!-- Tailwind CSS CDN -->

    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome CDN -->

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>

        /* Özel Tailwind renkleri ve genel stil ayarları */

        :root {

            --primary: #5b21b6; /* Purple-700 */

            --secondary: #8b5cf6; /* Purple-500 */

            --background: #1f2937; /* Gray-800 */

            --card-bg: #374151; /* Gray-700 */

            --text-color: #f3f4f6; /* Gray-100 */

        }

        body {

            font-family: 'Inter', sans-serif;

            background-color: var(--background);

            color: var(--text-color);

            min-height: 100vh;

        }

        /* Kaydırma çubuğu stilini özelleştirme */

        ::-webkit-scrollbar { width: 8px; }

        ::-webkit-scrollbar-track { background: var(--background); }

        ::-webkit-scrollbar-thumb { background: var(--secondary); border-radius: 4px; }

        ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        .rating input:checked ~ label,

        .rating label:hover,

        .rating label:hover ~ label {

            color: #facc15; /* Yellow-400 */

        }

        /* Toast Bildirimi Stili */

        #toast-container {

            position: fixed;

            top: 1rem;

            right: 1rem;

            z-index: 60;

            max-width: 90%;

            transition: transform 0.3s ease-in-out, opacity 0.3s ease-in-out;

        }

        

        /* Açıklama Kısaltma ve Genişletme Stili */

        .description-truncate {

            max-height: 50px; 

            overflow: hidden;

            position: relative;

            transition: max-height 0.3s ease-out;

        }

        .description-truncate.expanded {

            max-height: 500px; 

            overflow: visible;

        }

        .description-truncate:not(.expanded)::after {

            content: "";

            position: absolute;

            bottom: 0;

            left: 0;

            right: 0;

            height: 1.5rem; 

            background: linear-gradient(to top, var(--card-bg), rgba(55, 65, 81, 0));

        }

    </style>

</head>

<body>

    

    <!-- Header (Tüm Sayfalar İçin Ortak) -->

    <header class="text-center py-6 border-b-2 border-purple-700 mb-6 sticky top-0 bg-gray-800 z-10">

        <h1 class="text-4xl font-extrabold text-purple-400">Ellolist</h1>

        <p class="text-lg text-gray-300">Kişisel Medya Takip Uygulaması</p>

    </header>

    <!-- Ana Liste Görünümü -->

    <div class="p-4 sm:p-6">

        

        <!-- Kontrol Paneli: Ekle, Filtre, Sırala, Arama, İstatistikler -->

        <div class="bg-gray-700 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-3 items-center">

            

            <!-- 1. Yeni Ekle Düğmesi (add_edit.html'e yönlendirildi) -->

            <a href="add_edit.html" class="flex-shrink-0">

                <button class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300">

                    <i class="fas fa-plus mr-1"></i> Yeni Ekle

                </button>

            </a>

            <!-- Filtreler ve Sıralama Grubu -->

            <div class="flex flex-col sm:flex-row gap-3 w-full sm:w-auto sm:ml-auto">

                

                <!-- Arama Çubuğu -->

                <input type="text" id="search-input" placeholder="Başlıkta Ara..." class="p-2 rounded-lg bg-gray-600 border border-gray-500 text-white placeholder-gray-400 focus:ring-purple-500 focus:border-purple-500 w-full sm:w-40 transition duration-300" onkeyup="handleSearchFilter()">

                <!-- Kategoriye Göre Filtre -->

                <select id="category-filter" class="p-2 rounded-lg bg-gray-600 border border-gray-500 text-white focus:ring-purple-500 focus:border-purple-500 w-full sm:w-36 transition duration-300" onchange="handleSearchFilter()">

                    <option value="">Kategori Seç</option>

                    <option value="Kitap">Kitap</option>

                    <option value="Roman">Roman</option>

                    <option value="Webtoon">Webtoon</option>

                    <option value="Manga">Manga</option>

                    <option value="Film">Film</option>

                    <option value="Dizi">Dizi</option>

                    <option value="Anime">Anime</option>

                    <option value="Müzik">Müzik</option>

                    <option value="Podcast">Podcast</option>

                </select>

                

                <!-- Türe Göre Filtre -->

                <select id="genre-filter" class="p-2 rounded-lg bg-gray-600 border border-gray-500 text-white focus:ring-purple-500 focus:border-purple-500 w-full sm:w-36 transition duration-300" onchange="handleSearchFilter()">

                    <option value="">Türe Göre Filtrele</option>

                    <option value="Fantezi">Fantezi</option>

                    <option value="Bilim Kurgu">Bilim Kurgu</option>

                    <option value="Dram">Dram</option>

                    <option value="Komedi">Komedi</option>

                    <option value="Aksiyon">Aksiyon</option>

                    <option value="Gerilim">Gerilim</option>

                    <option value="Belgesel">Belgesel</option>

                    <option value="Biyografi">Biyografi</option>

                    <option value="Diğer">Diğer</option>

                </select>

                <!-- Özel Sıralama -->

                <select id="sort-order" class="p-2 rounded-lg bg-gray-600 border border-gray-500 text-white focus:ring-purple-500 focus:border-purple-500 w-full sm:w-36 transition duration-300" onchange="handleSort()">

                    <option value="eklenmeTarihiDesc">Eklenme Tarihine (Yeni-Eski)</option>

                    <option value="baslikAsc">Başlık (A-Z)</option>

                    <option value="durum">Durum</option>

                    <option value="puanlamaDesc">Puanlama (Yüksek-Düşük)</option>

                </select>

            </div>

        </div>

        

        <!-- İstatistikler ve Yedekleme Düğmeleri -->

        <div class="bg-gray-700 p-4 rounded-xl shadow-lg mb-6 flex flex-wrap gap-3 justify-center sm:justify-start">

            <!-- 2. İstatistikler Butonu (stats.html'e yönlendirildi) -->

            <a href="stats.html" class="w-full sm:w-auto">

                <button class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full sm:w-auto">

                    <i class="fas fa-chart-bar mr-1"></i> İstatistikler

                </button>

            </a>

            

            <button id="export-data-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transition duration-300 w-full sm:w-auto">

                <i class="fas fa-download mr-1"></i> Dışa Aktar (JSON)

            </button>

            <label for="import-file" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-lg shadow-md cursor-pointer transition duration-300 w-full sm:w-auto text-center">

                <i class="fas fa-upload mr-1"></i> İçe Aktar (JSON)

            </label>

            <input type="file" id="import-file" accept="application/json" class="hidden">

        </div>

        <!-- Medya Listesi -->

        <section id="media-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6"></section>

        <!-- Liste Boş Mesajı -->

        <p id="empty-list-message" class="text-center text-gray-400 mt-12 text-xl hidden">Henüz bir öğe eklemediniz. Başlamak için "Yeni Ekle" düğmesine basın!</p>

    </div>

    

    <!-- Modal ve Toast Alanları -->

    <div id="toast-container"></div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">

        <div class="bg-gray-700 p-6 rounded-lg shadow-xl max-w-sm w-full">

            <h3 class="text-xl font-bold text-red-400 mb-4">Onay Gerekiyor</h3>

            <p id="modal-message" class="text-gray-200 mb-6">Bu işlemi yapmak istediğinizden emin misiniz?</p>

            <div class="flex justify-end gap-3">

                <button id="cancel-action" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-lg">İptal</button>

                <button id="confirm-action" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-lg">Onayla</button>

            </div>

        </div>

    </div>

    <script type="module">

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        import { getFirestore, onSnapshot, collection, query, doc, deleteDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        

        setLogLevel('Debug');

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'ellolist-default';

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId;

        let isAuthReady = false;

        let allItems = []; // Tüm öğeleri burada tut

        const mediaListSection = document.getElementById('media-list');

        const emptyListMessage = document.getElementById('empty-list-message');

        const searchInput = document.getElementById('search-input');

        const categoryFilter = document.getElementById('category-filter');

        const genreFilter = document.getElementById('genre-filter');

        const sortOrder = document.getElementById('sort-order');

        const confirmModal = document.getElementById('confirmation-modal');

        const confirmActionBtn = document.getElementById('confirm-action');

        const cancelActionBtn = document.getElementById('cancel-action');

        const modalMessage = document.getElementById('modal-message');

        let currentFilter = {

            search: '',

            category: '',

            genre: '',

            sort: 'eklenmeTarihiDesc'

        };

        function getCollectionPath() { return `artifacts/${appId}/users/${userId}/mediaItems`; }

        function getDocumentRef(id) { return doc(db, getCollectionPath(), id); }

        

        // Firebase başlatma ve kullanıcı yetkilendirme

        async function initializeFirebase() {

            if (!firebaseConfig) { 

                console.error("Firebase config is missing."); 

                userId = crypto.randomUUID(); 

                isAuthReady = true; 

                showToast("Firebase yapılandırması eksik.", "error"); 

                return; 

            }

            

            const app = initializeApp(firebaseConfig);

            db = getFirestore(app);

            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {

                userId = user ? user.uid : crypto.randomUUID();

                isAuthReady = true;

                console.log("Authentication ready. User ID:", userId);

                loadMediaList();

            });

            try {

                if (initialAuthToken) { await signInWithCustomToken(auth, initialAuthToken); } 

                else if (!auth.currentUser) { await signInAnonymously(auth); }

            } catch (error) { 

                console.error("Firebase sign-in error:", error); 

                showToast("Giriş yapılırken hata oluştu.", "error");

                await signInAnonymously(auth); 

            }

        }

        

        // Firestore'dan verileri gerçek zamanlı yükleme

        function loadMediaList() {

            if (!isAuthReady || !db) return;

            const itemsCollectionRef = collection(db, getCollectionPath());

            const q = query(itemsCollectionRef); 

            onSnapshot(q, (snapshot) => {

                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                console.log(`Loaded ${allItems.length} items from Firestore.`);

                // Yeni veriler geldiğinde filtreleme ve sıralama tekrar yapılır

                handleSearchFilter(); 

            }, (error) => {

                console.error("Error fetching media items:", error);

                showToast("Veriler yüklenirken bir hata oluştu.", "error");

            });

        }

        // Filtreleme, Sıralama ve Arama İşlemini Yöneticisi

        window.handleSearchFilter = function() {

            currentFilter.search = searchInput.value.toLowerCase().trim();

            currentFilter.category = categoryFilter.value;

            currentFilter.genre = genreFilter.value;

            

            let filteredItems = allItems.filter(item => {

                // Güvenlik kontrolleri eklendi

                const itemBaslik = item.baslik ? item.baslik.toLowerCase() : '';

                const itemKategori = item.kategori || '';

                const itemTur = item.tur || '';

                

                const matchesSearch = itemBaslik.includes(currentFilter.search);

                const matchesCategory = !currentFilter.category || itemKategori === currentFilter.category;

                const matchesGenre = !currentFilter.genre || itemTur === currentFilter.genre;

                

                return matchesSearch && matchesCategory && matchesGenre;

            });

            // Sıralama

            renderList(filteredItems);

        };

        

        // Sıralama İşlemi

        window.handleSort = function() {

            currentFilter.sort = sortOrder.value;

            let sortedItems = [...allItems]; // Kopyasını al

            sortedItems.sort((a, b) => {

                switch (currentFilter.sort) {

                    case 'baslikAsc':

                        return (a.baslik || '').localeCompare(b.baslik || '');

                    case 'durum':

                        const statusOrder = { 'İzleniyor': 1, 'Okunuyor': 2, 'Tamamlandı': 3, 'Planlandı': 4 };

                        return (statusOrder[a.durum] || 9) - (statusOrder[b.durum] || 9);

                    case 'puanlamaDesc':

                        return (b.puanlama || 0) - (a.puanlama || 0);

                    case 'eklenmeTarihiDesc':

                    default:

                        return new Date(b.creationDate || 0) - new Date(a.creationDate || 0);

                }

            });

            renderList(sortedItems);

        };

        

        // Liste Render Etme

        function renderList(items) {

            mediaListSection.innerHTML = '';

            

            if (items.length === 0) {

                emptyListMessage.classList.remove('hidden');

                return;

            }

            

            emptyListMessage.classList.add('hidden');

            items.forEach(item => {

                const card = document.createElement('div');

                card.className = 'stat-card bg-gray-700 rounded-xl shadow-lg p-4 flex flex-col transition duration-300 transform hover:scale-[1.01]';

                card.innerHTML = renderMediaItem(item);

                mediaListSection.appendChild(card);

            });

        }

        

        // Tek bir öğeyi render eden fonksiyon (HTML içeriğini oluşturur)

        function renderMediaItem(item) {

             // Güvenli Okuma için varsayılan değerler eklendi

            const baslik = item.baslik ?? 'Başlık Yok';

            const kategori = item.kategori ?? 'Bilinmiyor';

            const durum = item.durum ?? 'Planlandı';

            const yayinYazar = item.yayinYazar ?? '';

            const tur = item.tur ?? 'Diğer';

            const puanlama = item.puanlama ?? 0;

            const kucukResim = item.kucukResim ?? 'https://placehold.co/100x150/5b21b6/ffffff?text=ELLO';

            const aciklama = item.aciklama ?? 'Açıklama mevcut değil.';

            

            const mevcut = item.mevcutIlerlemeDegeri ?? 0;

            const toplam = item.toplamIlerlemeDegeri ?? 0;

            const birim = item.ilerlemeBirimi ?? 'Bölüm';

            let statusColor, statusText;

            switch (durum) {

                case 'Tamamlandı': statusColor = 'bg-green-600'; statusText = 'Tamamlandı'; break;

                case 'İzleniyor': statusColor = 'bg-yellow-600'; statusText = 'İzleniyor'; break;

                case 'Okunuyor': statusColor = 'bg-blue-600'; statusText = 'Okunuyor'; break;

                case 'Planlandı':

                default: statusColor = 'bg-gray-500'; statusText = 'Planlandı'; break;

            }

            const progress = toplam > 0 ? Math.round((mevcut / toplam) * 100) : 0;

            const progressDisplay = toplam > 0 ? 

                `<div class="mt-2 text-sm text-gray-300">${mevcut} / ${toplam} ${birim} (${progress}%)</div>

                <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">

                    <div class="h-2.5 rounded-full ${statusColor}" style="width: ${progress}%"></div>

                </div>` : 

                `<div class="mt-2 text-sm text-gray-400">İlerleme takip edilmiyor</div>`;

            const ratingStars = Array(5).fill(0).map((_, i) => 

                `<i class="fas fa-star ${i < puanlama ? 'text-yellow-400' : 'text-gray-500'} text-lg"></i>`

            ).join('');

            return `

                <div class="flex items-start gap-4 mb-4">

                    <!-- Küçük Resim -->

                    <img src="${kucukResim}" alt="${baslik} kapağı" class="w-24 h-32 object-cover rounded-lg flex-shrink-0 border border-purple-500">

                    

                    <div class="flex-grow min-w-0">

                        <!-- Başlık ve Durum -->

                        <div class="flex justify-between items-center">

                            <h3 class="text-xl font-bold text-white truncate">${baslik}</h3>

                            <span class="text-xs font-semibold px-2 py-0.5 rounded-full ${statusColor} text-white whitespace-nowrap">${statusText}</span>

                        </div>

                        

                        <!-- Yazar/Tür -->

                        <p class="text-sm text-gray-400 mt-1">

                            ${yayinYazar ? `<i class="fas fa-user mr-1"></i> ${yayinYazar} | ` : ''}

                            <i class="fas fa-layer-group mr-1"></i> ${kategori} (${tur})

                        </p>

                        <!-- Puanlama -->

                        <div class="mt-1 flex items-center">

                            ${ratingStars}

                        </div>

                    </div>

                </div>

                <!-- Açıklama ve İlerleme -->

                <div class="flex-grow">

                    <div id="desc-${item.id}" class="description-truncate bg-gray-600 p-3 rounded-lg text-sm text-gray-200">

                        ${aciklama}

                    </div>

                    ${aciklama.length > 100 ? `<button onclick="toggleDescription('${item.id}')" class="text-purple-400 text-xs mt-1 block hover:text-purple-300">Daha fazla oku...</button>` : ''}

                    

                    ${progressDisplay}

                </div>

                <!-- Aksiyonlar -->

                <div class="mt-4 flex justify-end gap-2">

                    <a href="add_edit.html?id=${item.id}" class="flex-shrink-0">

                        <button class="bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-semibold py-1 px-3 rounded-lg shadow-md transition duration-300">

                            <i clas